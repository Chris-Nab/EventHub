<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{components/layout :: layout(~{::title}, ~{::section})}"
>
  <head>
    <title>EventHub</title>
  </head>
  <body>
    <section class="page">
      <!-- Hero -->
      <div class="hero">
        <div class="hero-text">
          <h1>Discover Amazing Events in your university</h1>
          <p>
            Connect with your university clubs and societies through exciting events, workshops, and meetups. 
            Find events that match your interests and create lasting memories.
          </p>
          <div class="hero-cta">
            <a sec:authorize="!isAuthenticated()"  th:href="@{/login}"class="btn btn-light">Sign in</a>
            <a sec:authorize="!isAuthenticated()" th:href="@{/register}"class="btn btn-dark">Register</a>
          </div>
        </div>
      </div>
      <div class="hero-media">
        <div class="media-placeholder">
          <div class="hero-wrap">
            <img class="hero-img" th:src="@{/homePage.jpg}" alt="Home page image">
          </div>
        </div>
      </div>

      <!-- Section title -->
      <h2 class="section-title">
        Browsing events in <span class="muted">RMIT</span>
      </h2>

      <a href="/recommendations" class="btn btn-primary">View Recommended Events</a>

      <!-- Labels/filters (static placeholders for now) -->
      <div class="chip-row">
        <div th:replace="~{components/eventFilters :: filterForm}"></div>
  
      </div>

      <!-- <div class="createEventBtn">
        <a  th:href="@{/eventPage}" class="btn btn-dark"> Create Event </a>
      </div> -->

      <!-- Showing event cards-->
      <div class="cards">
        <!--When there are no events -->
        <div class="empty-events" th:if="${#lists.isEmpty(events)}">
          No upcoming events
        </div>

        <article
          th:each="event : ${events}"
          class="card"
          th:if="${!#lists.isEmpty(events)}"
        >
          <div class="card-body">
            <h3 class="card-title" th:text="${event.name}">Event</h3>
            <div class="card-price">
              <span th:text="${event.price != null && event.price > 0 ? '$' + #numbers.formatDecimal(event.price , 1, 'COMMA', 2, 'POINT') : 'Free'}">Free</span>
            </div>
            <p class="card-text" th:text="${event.description != null ? event.description : 'Event description goes here...'}">Body text.</p>
            
            <!-- Event Categories -->
            <div class="card-categories" th:if="${!#lists.isEmpty(event.category)}">
              <span th:each="catName : ${event.category}" class="chip" th:text="${catName}">Category</span>
            </div>

               <div class="card-actions">              
              

              <!-- <div> this is appear if role is ADMIN</div> -->
              <!-- <div sec:authorize="hasRole('ADMIN')"  class="admin-actions" >
                <a th:href="@{'/event/edit/' + ${event.eventId}}" class="btn btn-outline btn-light  btn-sm">Edit</a>
                <form th:action="@{'/event/delete/' + ${event.eventId}}" method="post" style="display:inline;">
                  <button type="submit" onclick="return confirm('Are you sure you want to delete this event?');" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </div> -->


                <!-- <div> this is appear if role is ORGAINSISER AND IT CREATE BY THAT PERSON_ID </div> -->
              <!-- <div sec:authorize="hasRole('ORGANISER')" th:if="${event.createdByUserId} == ${currentUserId} " class="admin-actions" >
                <div>your event</div>
                <a th:href="@{'/event/edit/' + ${event.eventId}}" class="btn btn-outline btn-light  btn-sm">Edit</a>
                <form th:action="@{'/event/delete/' + ${event.eventId}}" method="post" style="display:inline;">
                  <button type="submit" onclick="return confirm('Are you sure you want to delete this event?');" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </div> -->

            </div>
          </div>

            <!-- Event Details -->
            <div class="card-meta">
              <span class="meta-item">üìÖ <span th:text="${#temporals.format(event.dateTime, 'MMM d')}">Date</span></span>
              <span class="meta-item">üìç <span th:text="${event.location}">Location</span></span>
            </div>
          <div class="card-media">
            <div class="img-placeholder">
              <div class="placeholder-icon">
                <img th:src="@{${event.imageUrl}}" alt="event image" class="event-card-image">
              </div>
            </div>
          </div>  
          <!-- View Details button -->
          <button
          type="button"
          class="btn btn-dark"
          th:attr="data-event-id=${event.eventId}"
          onclick="openEventModal(this)"
          >
          View Details
          </button>

          <!-- Hidden modal template for THIS event -->
          <template th:id="'event-template-' + ${event.eventId}">
          <th:block th:replace="~{components/eventDetail :: eventDetails(event=${event})}"></th:block>
          </template>

          <!-- RSVP Buttons -->
              <form th:action="@{'/rsvp/' + ${currentUserId} + '/event/' + ${event.eventId}}" method="get" class="rsvp-form">
                <button 
                  type="submit"
                  style="width:100%"
                  th:classappend="${rsvpStatusMap[event.eventId]} ? 'btn btn-green submit-button' : 'btn btn-dark submit-button'"
                  th:disabled="${rsvpStatusMap[event.eventId]}"
                  th:text="${rsvpStatusMap[event.eventId]} ? 'RSVPed' : 'RSVP'"
                >RSVP</button>
              </form>
              <div th:if = "${rsvpStatusMap[event.eventId]}">
                <form th:action="@{'/rsvp/' + ${currentUserId} + '/event/' + ${event.eventId} + '/delete'}" method="post"
                      onsubmit="return confirm('Are you sure you want to DELETE this RSVP ?');">
                  <button 
                    type="submit"
                    style="width:100%"
                    class="btn submit-button"
                    th:text="'Cancel this RSVP'"
                  >Cancel this RSVP</button>
                </form>
              </div>
        </article>
      </div>
      </div>

      <!-- Stats (placeholders) -->
      <div class="stats">
        <div class="stat">
          <div class="stat-num">24+</div>
          <div class="stat-sub">Organizers use our website</div>
        </div>
        <div class="stat">
          <div class="stat-num">17M</div>
          <div class="stat-sub">Number of current users</div>
        </div>
        <div class="stat">
          <div class="stat-num">+95%</div>
          <div class="stat-sub">Customer satisfaction</div>
        </div>
      </div>
      <div id="eventModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEventModal()">&times;</span>
          <div id="modal-body"></div>
        </div>
      </div>
      <script>
        function openEventModal(button) {
          const eventId = button.getAttribute("data-event-id");
          const template = document.getElementById("event-template-" + eventId);
          if (!template) return;
          document.getElementById("modal-body").innerHTML = template.innerHTML;
          document.getElementById("eventModal").style.display = "block";
        }
        function closeEventModal() {
          document.getElementById("eventModal").style.display = "none";
        }
        window.onclick = function (event) {
          const modal = document.getElementById("eventModal");
          if (event.target === modal) closeEventModal();
        };
      </script>
    </section>
  </body>
</html>
