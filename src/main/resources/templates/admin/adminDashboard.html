<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  lang="en"
  th:replace="~{components/layout :: layout(~{::title}, ~{::section})}"
>
  <head>
    <title>Admin Dashboard</title>
    <link
      rel="stylesheet"
      th:href="@{/styles.css(v=${#temporals.format(#temporals.createNow(),'yyyyMMddHHmmss')})}"
    />
  </head>
  <body>
    <section class="page">
      <!-- Hero -->
      <div class="hero">
        <div class="hero-text">
          <h1>Welcome to admin dashboard!</h1>
        </div>
      </div>

      <div class="divider"></div>
      <!-- Upcoming Events -->
      <h2 class="section-title">Reported events</h2>

      <!-- Error message -->
      <div th:if="${error}" class="alert alert-error" th:text="${error}">
        Event not found or not hosted by you.
      </div>

      <!-- Empty state -->
      <div th:if="${#lists.isEmpty(events)}" class="empty-events">
        You havenâ€™t had any reported event yet...
      </div>

      <!-- Event Cards -->
      <div class="cards" th:if="${!#lists.isEmpty(events)}">
        <article class="card" th:each="ev : ${events}">
          <div class="card-body">
            <!-- Title + inline categories -->
            <div class="title-row">
              <h3 class="card-title" th:text="${ev.event.name}">Event name</h3>
              <div class="chip-row-inline" th:if="${ev.event.category != null}">
                <span class="chip" th:each="c : ${ev.event.category}" th:text="${c}"
                  >Category</span
                >
              </div>
            </div>

            <p
              class="muted"
              th:text="${#temporals.format(ev.event.dateTime, 'EEE, d MMM yyyy HH:mm')}"
            >
              Date
            </p>
            <p class="muted" th:text="${ev.event.location}">Location</p>

            <p>Reports:</p>
            <ul>
                <li th:each="entry : ${ev.reportCounts.entrySet()}" 
                    th:text="${entry.key + ': ' + entry.value}">Status: Count</li>
            </ul>

            <!-- View Details button -->
            <button
              type="button"
              class="btn btn-dark"
              th:attr="data-event-id=${ev.event.eventId}"
              onclick="openEventModal(this)"
            >
              View Details
            </button>

            <!-- Hidden modal template for THIS event -->
            <template th:id="'event-template-' + ${ev.event.eventId}">
              <th:block
                th:replace="~{components/eventDetail :: eventDetails(event=${ev.event})}"
              ></th:block>
            </template>

            <div class="card-actions">
              <a
                class="btn btn-dark"
                th:href="@{|/admin/events/${ev.event.eventId}/reports|}"
              >
                View Reports
              </a>

              <a
                class="btn btn-blue"
                th:href="@{'/admin/event/edit/' + ${ev.event.eventId}}"
              >
                Edit
              </a>

              <form th:if="(${ev.reportCounts['open'] ?: 0} + ${ev.reportCounts['under_review'] ?: 0}) > 0"
                    th:action="@{'/admin/event/dismiss/' + ${ev.event.eventId}}"
                    method="post"
                    class="inline"
                    onsubmit="return confirm('Are you sure you want to dismiss this event?');">
                  <button type="submit" class="btn btn-blue">Dismiss</button>
              </form>
              
              <form
                th:action="@{'/admin/event/softdelete/' + ${ev.event.eventId}}"
                 method="post"
                 class="inline"
                 onsubmit="return confirm('Are you sure you want to delete this event?');"
               >
                <button type="submit" class="btn btn-danger">Move to Bin</button>
               </form>
            </div>
          </div>
        </article>
      </div>

      <div class="divider"></div>
      <div class="hero">
        <div class="hero-text">
          <h1>Admin's Features</h1>
          <div class="hero-cta">
            <a th:href="@{/admin/users}" class="btn btn-blue">User Management</a>
            <a th:href="@{/}" class="btn btn-light">Explore Events</a>
            <a th:href="@{/admin/event/bin}" class="btn btn-dark">Recycle Bin</a>
          </div>
        </div>
      </div>

      <!-- Global modal (single instance on the page) -->
      <div id="eventModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeEventModal()">&times;</span>
          <div id="modal-body"></div>
        </div>
      </div>
      <script>
        function openEventModal(button) {
          const eventId = button.getAttribute("data-event-id");
          const template = document.getElementById("event-template-" + eventId);
          if (!template) return;
          document.getElementById("modal-body").innerHTML = template.innerHTML;
          document.getElementById("eventModal").style.display = "block";
        }
        function closeEventModal() {
          document.getElementById("eventModal").style.display = "none";
        }
        window.onclick = function (event) {
          const modal = document.getElementById("eventModal");
          if (event.target === modal) closeEventModal();
        };
      </script>
    </section>
  </body>
</html>
